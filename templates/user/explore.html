{% include 'user/user_header.html'%}

<style>
  /* Hide scroll bars */
  .section::-webkit-scrollbar {
    display: none;
  }

  .section {
    overflow: -moz-scrollbars-none;
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
</style>

<div class="page-header header-filter">

<!-- Side Bar -->
<div class="myfixleft sidebar">
  <div style="margin-top: 100px;">
    <div class="row">
      <div class="col-md-11">
        <ul class="nav nav-pills nav-pills-info flex-column">
          <li class="nav-item">
            <a class="nav-link d-flex align-items-center py-2" href="{{ url_for('user.user_home') }}">
              <i class="fas fa-home mr-2"></i> Home
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link d-flex align-items-center py-2" href="{{ url_for('user.favorite') }}">
              <i class="fas fa-heart mr-2"></i> Favorites
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link active d-flex align-items-center py-2" href="{{ url_for('user.explore') }}">
              <i class="fas fa-compass mr-2"></i> Explore
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>
<!-- End Side Bar -->

  <div class="section" style="margin-top: 50px; margin-left: 220px; overflow-y: scroll; max-height: 660px;">
  <!-- Search -->
    <div>
    <!-- Search Bar -->
    <div class="container">
      <div class="row">
        <div class="col col-8">
          <div class="input-group">
            <input id="search-input" type="text" class="form-control" placeholder="Search">
            <div class="input-group-append">
              <span class="input-group-text"><i class="fas fa-search"></i></span>
            </div>
          </div>
        </div>
      </div>
      <div style="margin-top: 30px;">
        <!-- Space for the content below-->
      </div>
    </div>
    <!-- End Search Bar -->

    <!-- Search Result -->
    <div id="SearchResultArea" class="session hidden">
      <div class="row">
        <!-- Top Result -->
        <div class="col col-5 hidden" id="TopResultArea">
          <h2 class="text-success ml-3 mt-3"> Top Result </h2>
          <div class="card">
            <div class="container mt-3">
              <div class="row">
                <div class="col">
                  <div class="col-sm-3 col-6">
                    <img id="TopSearchImage" src="{{ url_for('static', filename='public/img/defaultavathar.png') }}"
                      alt="Circle image" class="img-fluid rounded-circle shadow" style="width: 150px;">
                  </div>
                </div>
              </div>
              <div class="row mt-3">
                <div class="col col-10">
                  <h3 class="mb-2" id="TopSearchSongName">Song Name</h3>
                  <h6 class="my-1" id="TopSearchArtistName">Artist Name <span
                      class="badge badge-default ml-3">Song</span></h6>
                  <h6 class="my-1" id="TopSearchDuration">Duration</h6>
                </div>
                <div class="col text-right col-2">
                  <form action="{{ url_for('user.play') }}" method="POST" role="tab">
                    <input type="hidden" name="contenttype" id="contenttype" value="">
                    <input type="hidden" name="song_id" class="contenID" value="">
                    <input type="hidden" name="album_id" class="contenID" value="">
                    <input type="hidden" name="artist_id" class="contenID" value="">
                    <button class="btn btn-success btn-lg btn-round btn-icon" id="play-pause-button-page" type="submit">
                      <i class="fas fa-play"></i>
                    </button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Songs Result -->
        <div class="col col-7 hidden" id="SongResultArea">
          <h2 class=" ml-3 mt-3"> Songs </h2>
          <div class="card text-center">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th class="text-center">#</th>
                  <th>Song Name</th>
                  <th>Genre</th>
                  <th>Language</th>
                  <th>Duration</th>
                </tr>
              </thead>
              <tbody id="search-results">
                <!-- Results will be dynamically added here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col" id="ArtistListArea">
          <h3>Artists</h3>
          <div>
            <ul class="nav nav-pills nav-pills-success nav-pills-icons" id="artist-list" role="tablist">
              <!-- color-classes: "nav-pills-primary", "nav-pills-info", "nav-pills-success", "nav-pills-warning", "nav-pills-danger" -->

              <!-- Add more list items as needed -->
            </ul>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col" id="AlbumListArea">
          <h3>Album</h3>
          <div>
            <ul class="nav nav-pills nav-pills-success nav-pills-icons" id="album-list" role="tablist">
              <!-- color-classes: "nav-pills-primary", "nav-pills-info", "nav-pills-success", "nav-pills-warning", "nav-pills-danger" -->
            </ul>
          </div>
        </div>
      </div>
    </div>
    <!-- End Search Result -->
    <!-- No Element Found Area -->
    <div id="SearchResultNotFound" class="session text-center hidden">
      <h1 class="text-warning"> No matching Contents Found !!!!!</h1>

    </div>
    </div>
  <!-- End Search -->

  <!-- Other contents-->
  <div class="row">
  <div class="col-12">
  <h1> Other Contents</h1>
  </div>
  </div>
  <!-- End Other contents-->

  </div>
  
</div>

<style>
  button {
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
  }

  button .image-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    transition: filter 0.3s ease;
    filter: blur(0);
  }

  button:hover .image-container {
    filter: blur(5px);
  }

  button .overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background-color: rgba(0, 0, 0, 0.7);
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  button:hover .overlay {
    opacity: 1;
  }

  button .text-name {
    font-size: 1.5rem;
    font-weight: bold;
    color: white;
    margin-bottom: 0.5rem;
    position: absolute;
    bottom: 0;
    left: 0;
    padding: 10px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
</style>

{% include 'user/user_footer.html'%}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  $(document).ready(function () {
    var searchInput = $('#search-input');
    var SearchResultArea = document.getElementById('SearchResultArea');
    var SearchResultNotFound = document.getElementById('SearchResultNotFound');
    var TopResultArea = document.getElementById('TopResultArea');
    var ArtistListArea = document.getElementById('ArtistListArea');
    var AlbumListArea = document.getElementById('AlbumListArea');
    // Capture user input and send it to Flask
    searchInput.on('input', function () {
      var searchText = searchInput.val();

      // Check if search text is empty or less than 3 characters
      if (searchText === '' || searchText.length < 3) {
        // Clear the previous results
        $('#search-results tbody').empty();
        $('#artist-list').empty();
        $('#album-list').empty();
        $('#TopSearchSongName').text('Song Name');
        $('#TopSearchArtistName').text('');
        $('#TopSearchDuration').text('');
        $('#TopSearchImage').attr('src', '');
        SearchResultArea.classList.add('hidden');
        SearchResultNotFound.classList.add('hidden');
        return; // Exit the function
      }

      $.ajax({
        type: 'POST',
        url: '/user/search',
        data: { text: searchText },
        success: function (response) {
          console.log(response)
          // Clear the previous results
          $('#search-results').empty();
          $('#artist-list').empty();
          $('#album-list').empty();
          $('#TopSearchSongName').text('Song Name');
          $('#TopSearchArtistName').text('');
          $('#TopSearchDuration').text('');
          $('#TopSearchImage').attr('src', '');
          var SongResultArea = document.getElementById('SongResultArea');
          var song_score = 0;
          var artist_score = 0;
          var album_score = 0;

          if (response['matching_songs'].length > 0)
            song_score = response['matching_songs'][0].score;
          if (response['matching_albums'].length > 0)
            album_score = response['matching_albums'][0].score;
          if (response['matching_artists'].length > 0)
            artist_score = response['matching_artists'][0].score;

          var highest_score = Math.max(song_score, album_score, artist_score);
          var result;

          if (highest_score === song_score && highest_score > 0) {
            result = "matching_songs";
          } else if (highest_score === album_score && highest_score > 0) {
            result = "matching_albums";
          } else if (highest_score === artist_score && highest_score > 0) {
            result = "matching_artists";
          }

          if (result === 'matching_songs' || result === 'matching_albums' || result === 'matching_artists') {
            SearchResultNotFound.classList.add('hidden');
            SearchResultArea.classList.remove('hidden');
            if (result === 'matching_songs') {
              TopResultArea.classList.remove('hidden');
              // Update the top result
              var topResult = response['matching_songs'][0];

              // Update the song name
              var songNameElement = document.getElementById('TopSearchSongName');
              songNameElement.textContent = topResult['song_name'];

              // Update the artist name
              var artistNameElement = document.getElementById('TopSearchArtistName');
              artistNameElement.textContent = topResult['artist_name'];

              // Update the duration
              var durationElement = document.getElementById('TopSearchDuration');
              durationElement.textContent = topResult['duration'];

              // Update the image source
              var imageElement = document.getElementById('TopSearchImage');
              imageElement.src = '{{ url_for('static', filename='') }}' + topResult['image_loc'];

              // Set the song_id as a data attribute on the play button related
              // Set the value of the 'contenttype' hidden input field
              document.getElementById("contenttype").value = "SearchSong";

              // Set the value of the 'artist_id' hidden input field
              document.querySelectorAll('.contenID').forEach(input => input.value = topResult['song_id']);

            }
            else if (result === 'matching_albums') {
              TopResultArea.classList.remove('hidden');
              // Update the top result
              var topResult = response['matching_albums'][0];

              // Update the song name
              var songNameElement = document.getElementById('TopSearchSongName');
              songNameElement.textContent = topResult['album_name'];

              // Update the artist name
              var artistNameElement = document.getElementById('TopSearchArtistName');
              artistNameElement.textContent = 'Album';

              // Update the duration
              var durationElement = document.getElementById('TopSearchDuration');
              durationElement.textContent = '';

              // Update the image source
              var imageElement = document.getElementById('TopSearchImage');
              imageElement.src = '{{ url_for('static', filename='') }}' + topResult['image_loc'];

              // Set the song_id as a data attribute on the play button related
              // Set the value of the 'contenttype' hidden input field
              document.getElementById("contenttype").value = "album";

              // Set the value of the 'artist_id' hidden input field
              document.querySelectorAll('.contenID').forEach(input => input.value = topResult['album_id']);
            }
            else if (result === 'matching_artists') {
              TopResultArea.classList.remove('hidden');
              // Update the top result
              var topResult = response['matching_artists'][0];

              // Update the song name
              var songNameElement = document.getElementById('TopSearchSongName');
              songNameElement.textContent = topResult['artist_name'];

              // Update the artist name
              var artistNameElement = document.getElementById('TopSearchArtistName');
              artistNameElement.textContent = 'Artist';

              // Update the duration
              var durationElement = document.getElementById('TopSearchDuration');
              durationElement.textContent = '';

              // Update the image source
              var imageElement = document.getElementById('TopSearchImage');
              imageElement.src = '{{ url_for('static', filename='') }}' + topResult['image_loc'];

              // Set the song_id as a data attribute on the play button related
              // Set the value of the 'contenttype' hidden input field
              document.getElementById("contenttype").value = "artist";

              // Set the value of the 'artist_id' hidden input field
              document.querySelectorAll('.contenID').forEach(input => input.value = topResult['artist_id']);
            }

          }
          else {
            TopResultArea.classList.add('hidden');
          }

          if (response['matching_songs'].length > 0 || response['matching_albums'].length > 0 || response['matching_artists'].length > 0) {
            if (response['matching_songs'].length > 0) {
              SongResultArea.classList.remove('hidden');
              // Loop through the results and append them to the table
              for (var i = 0; i < response['matching_songs'].length; i++) {
                var result = response['matching_songs'][i];
                var row = '<tr>';
                row += '<td class="text-center">' + (i + 1) + '</td>';
                row += '<td>' + result['song_name'] + '</td>';
                row += '<td>' + result['genre'] + '</td>';
                row += '<td>' + result['language'] + '</td>';
                row += '<td>' + result['duration'] + '</td>';
                row += '<td>';
                row += '<form action="/user/play" method="POST" role="tab">';
                row += '<input type="hidden" name="contenttype" id="contenttype" value="SearchSong">';
                row += '<input type="hidden" name="song_id" class="contenID" value="' + result['song_id'] + '">';
                row += '<button class="btn btn-success btn-sm btn-round btn-icon" id="play-pause-button-page" type="submit">';
                row += '<i class="fas fa-play"></i>';
                row += '</button>';
                row += '</form>';
                row += '</td>';
                row += '</tr>';

                // Append the row to the table body
                $('#search-results').append(row);
              }

            }
            else {
              SongResultArea.classList.add('hidden');
            }
            if (response['matching_artists'].length > 0) {
              ArtistListArea.classList.remove('hidden');
              for (var i = 0; i < response['matching_artists'].length; i++) {
                var artist = response['matching_artists'][i];
                var listItem = document.createElement('li');
                listItem.className = 'nav-item';
                listItem.style.marginRight = '30px';

                var form = document.createElement('form');
                form.action = '/user/play';
                form.method = 'POST';
                form.role = 'tab';

                var contentTypeInput = document.createElement('input');
                contentTypeInput.type = 'hidden';
                contentTypeInput.name = 'contenttype';
                contentTypeInput.value = 'artist';

                var artistIdInput = document.createElement('input');
                artistIdInput.type = 'hidden';
                artistIdInput.name = 'artist_id';
                artistIdInput.value = artist['artist_id'];

                var button = document.createElement('button');
                button.className = 'btn btn-default btn-round nav-link album-button';
                button.type = 'submit';
                button.style.padding = '0';
                button.style.position = 'relative';
                button.style.overflow = 'hidden';

                var divContainer = document.createElement('div');
                divContainer.className = 'd-flex flex-column align-items-center';
                divContainer.style.width = '230px';
                divContainer.style.height = '230px';
                divContainer.style.overflow = 'hidden';
                divContainer.style.display = 'flex';
                divContainer.style.alignItems = 'center';
                divContainer.style.justifyContent = 'center';

                var imageContainer = document.createElement('div');
                imageContainer.className = 'image-container';
                imageContainer.style.position = 'absolute';
                imageContainer.style.top = '0';
                imageContainer.style.left = '0';
                imageContainer.style.width = '100%';
                imageContainer.style.height = '100%';
                imageContainer.style.transition = 'filter 0.3s ease';
                imageContainer.style.filter = 'blur(0)';

                var image = document.createElement('img');
                image.src = "{{ url_for('static', filename='') }}" + artist['image_loc']; // Add the appropriate filename here
                image.alt = 'Raised image';
                image.className = 'img-fluid rounded shadow-lg';
                image.style.objectFit = 'cover';
                image.style.width = '100%';
                image.style.height = '100%';

                var overlay = document.createElement('div');
                overlay.className = 'overlay';

                var textName = document.createElement('span');
                textName.className = 'text-name';
                textName.textContent = artist['artist_name'];

                // Construct the DOM structure
                imageContainer.appendChild(image);
                divContainer.appendChild(imageContainer);
                divContainer.appendChild(overlay);
                overlay.appendChild(textName);
                button.appendChild(divContainer);
                form.appendChild(contentTypeInput);
                form.appendChild(artistIdInput);
                form.appendChild(button);
                listItem.appendChild(form);

                // Append the list item to the appropriate container
                var container = document.getElementById('artist-list'); // Replace 'artist-list' with the ID of the container element
                container.appendChild(listItem);
              }

            }
            else
            {
              ArtistListArea.classList.add('hidden');
            }
            if (response['matching_albums'].length > 0) {
              AlbumListArea.classList.remove('hidden');
              for (var i = 0; i < response['matching_albums'].length; i++) {
                var album = response['matching_albums'][i];
                var listItem = document.createElement('li');
                listItem.className = 'nav-item';
                listItem.style.marginRight = '30px';

                var form = document.createElement('form');
                form.action = '/user/play';
                form.method = 'POST';
                form.role = 'tab';

                var contentTypeInput = document.createElement('input');
                contentTypeInput.type = 'hidden';
                contentTypeInput.name = 'contenttype';
                contentTypeInput.value = 'album';

                var albumIdInput = document.createElement('input');
                albumIdInput.type = 'hidden';
                albumIdInput.name = 'album_id';
                albumIdInput.value = album['album_id'];

                var button = document.createElement('button');
                button.className = 'btn btn-default btn-round nav-link album-button';
                button.type = 'submit';
                button.style.padding = '0';
                button.style.position = 'relative';
                button.style.overflow = 'hidden';

                var divContainer = document.createElement('div');
                divContainer.className = 'd-flex flex-column align-items-center';
                divContainer.style.width = '230px';
                divContainer.style.height = '230px';
                divContainer.style.overflow = 'hidden';
                divContainer.style.display = 'flex';
                divContainer.style.alignItems = 'center';
                divContainer.style.justifyContent = 'center';

                var imageContainer = document.createElement('div');
                imageContainer.className = 'image-container';
                imageContainer.style.position = 'absolute';
                imageContainer.style.top = '0';
                imageContainer.style.left = '0';
                imageContainer.style.width = '100%';
                imageContainer.style.height = '100%';
                imageContainer.style.transition = 'filter 0.3s ease';
                imageContainer.style.filter = 'blur(0)';

                var image = document.createElement('img');
                image.src = "{{ url_for('static', filename='') }}" + album['image_loc']; // Add the appropriate filename here
                image.alt = 'Raised image';
                image.className = 'img-fluid rounded shadow-lg';
                image.style.objectFit = 'cover';
                image.style.width = '100%';
                image.style.height = '100%';

                var overlay = document.createElement('div');
                overlay.className = 'overlay';

                var textName = document.createElement('span');
                textName.className = 'text-name';
                textName.textContent = album['album_name'];

                // Construct the DOM structure
                imageContainer.appendChild(image);
                divContainer.appendChild(imageContainer);
                divContainer.appendChild(overlay);
                overlay.appendChild(textName);
                button.appendChild(divContainer);
                form.appendChild(contentTypeInput);
                form.appendChild(albumIdInput);
                form.appendChild(button);
                listItem.appendChild(form);

                // Append the list item to the appropriate container
                var albumcontainer = document.getElementById('album-list');
                albumcontainer.appendChild(listItem);
              }

            }
            else
            {
              AlbumListArea.classList.add('hidden');
            }
          }
          else if (response['matching_songs'].length === 0 && response['matching_albums'].length === 0 && response['matching_artists'].length === 0) {
            SearchResultArea.classList.add('hidden');
            SearchResultNotFound.classList.remove('hidden');
          }
        },
        error: function (xhr, status, error) {
          console.log('An error occurred: ' + error);
        }
      });
    });

    // Clear the search results when the search bar is cleared
    searchInput.on('keyup', function () {
      if (searchInput.val() === '') {
        $('#search-results tbody').empty();
        $('#TopSearchSongName').text('Song Name');
        $('#TopSearchArtistName').text('');
        $('#TopSearchDuration').text('');
        $('#TopSearchImage').attr('src', '');
        SearchResultArea.classList.add('hidden');
        SearchResultNotFound.classList.add('hidden');
      }
    });
  });
</script>